apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: adot-collector
  namespace: observability
spec:
  mode: deployment
  serviceAccount: adot-collector
  # 환경 변수 주입 (K8s ConfigMap -> Pod Env)
  env:
    - name: AMP_WORKSPACE_ID
      valueFrom:
        configMapKeyRef:
          name: amp-config
          key: AMP_WORKSPACE_ID
  # [수정 포인트] config 아래 내용은 반드시 상위 config보다 들여쓰기가 되어야 합니다.
  config: |
    extensions:
      sigv4auth:
        region: "ap-northeast-2"
        service: "aps"

    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      # ElastiCache(Valkey) 모니터링을 위한 설정
      prometheus:
        config:
          scrape_configs:
            - job_name: 'elasticache-valkey'
              scrape_interval: 15s # 주기 설정 추가 권장
              static_configs:
                - targets: ['redis-exporter-service:9121']

    processors:
      batch:

    exporters:
      prometheusremotewrite:
        # ${env:VAR_NAME} 문법은 ADOT Collector 내부의 변수 치환 기능입니다.
        endpoint: "https://aps-workspaces.ap-northeast-2.amazonaws.com/workspaces/${env:AMP_WORKSPACE_ID}/api/v1/remote_write"
        auth:
          authenticator: sigv4auth

    service:
      extensions: [sigv4auth]
      pipelines:
        metrics:
          receivers: [otlp, prometheus]
          processors: [batch]
          exporters: [prometheusremotewrite]
